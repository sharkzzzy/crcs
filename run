import torch
import os
from diffusers import StableDiffusionXLPipeline
from pipeline_carc import CARCPipeline, save_output

# ==============================================================================
# 1. é…ç½®ä¸æ¨¡å‹åŠ è½½ (FP32 å…¨ç²¾åº¦æ¨¡å¼)
# ==============================================================================
device = "cuda" if torch.cuda.is_available() else "cpu"
model_id = "stabilityai/stable-diffusion-xl-base-1.0"

print(f"ğŸš€ Loading SDXL model in FP32 Mode...")
try:
    # ç§»é™¤ torch_dtype=torch.float16ï¼Œé»˜è®¤å³ä¸º float32
    # ç§»é™¤ variant="fp16"ï¼Œç¡®ä¿åŠ è½½é»˜è®¤æƒé‡ï¼ˆæ›´ç¨³å®šï¼‰
    base_pipe = StableDiffusionXLPipeline.from_pretrained(
        model_id,
        use_safetensors=True,
        # local_files_only=True # å¦‚æœéœ€è¦ç¦»çº¿ï¼Œå–æ¶ˆæ³¨é‡Š
    ).to(device)
    
    # åŒé‡ä¿é™©ï¼šç¡®ä¿æ‰€æœ‰ç»„ä»¶éƒ½åœ¨ float32
    base_pipe.vae.to(dtype=torch.float32)
    base_pipe.text_encoder.to(dtype=torch.float32)
    base_pipe.text_encoder_2.to(dtype=torch.float32)
    base_pipe.unet.to(dtype=torch.float32)
    
except Exception as e:
    print(f"Error loading model: {e}")
    exit(1)

# ==============================================================================
# 2. åˆå§‹åŒ– CARC å¼•æ“
# ==============================================================================
print("ğŸ”§ Initializing CARC Engine...")
alpha_config = {
    "construct_phase": (0.0, 0.35, 0.2), 
    "texture_phase":   (0.35, 0.75, 0.8),
    "refine_phase":    (0.75, 1.0, 0.5),
}

carc_pipe = CARCPipeline(
    base_pipe=base_pipe,
    alpha_cfg=alpha_config
)

# ==============================================================================
# 3. å®šä¹‰ç”Ÿæˆä»»åŠ¡
# ==============================================================================
subjects = [
    {
        "name": "cat",
        "prompt": "a red cat, high detail, fluffy",
        "position": "left",
        "neg_target": "a blue dog"
    },
    {
        "name": "dog",
        "prompt": "a blue dog, high detail",
        "position": "right",
        "neg_target": "a red cat"
    }
]

global_prompt = "A sunny park background with green grass and trees, cinematic lighting, 8k, photorealistic"

# ==============================================================================
# 4. æ‰§è¡Œç”Ÿæˆ
# ==============================================================================
print("ğŸ¨ Generating image (FP32 mode, this may take longer)...")

seed = 42
output = carc_pipe(
    global_prompt=global_prompt,
    subjects=subjects,
    width=1024,
    height=1024,
    num_inference_steps=40,
    cfg_pos=7.5,
    cfg_neg=4.0,
    mask_update_interval=5,
    bg_update_interval=2, 
    beta=0.7,
    safety_expand=0.15,
    seed=seed
)

# ==============================================================================
# 5. ä¿å­˜ç»“æœ
# ==============================================================================
os.makedirs("outputs", exist_ok=True)
save_path = f"outputs/carc_demo_fp32_seed{seed}.png"
save_output(output, save_path)

print(f"âœ… Done! Image saved to: {save_path}")
