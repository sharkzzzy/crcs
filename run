run_carc_demo.py
python
import torch
import os
from diffusers import StableDiffusionXLPipeline
from pipeline_carc import CARCPipeline, save_output

# ==============================================================================
# 1. é…ç½®ä¸æ¨¡å‹åŠ è½½
# ==============================================================================
# å¼ºåˆ¶ä½¿ç”¨ç¦»çº¿æ¨¡å¼ï¼ˆå¦‚æœæ¨¡å‹å·²ä¸‹è½½ï¼‰
# os.environ["HF_HUB_OFFLINE"] = "1"

device = "cuda" if torch.cuda.is_available() else "cpu"
# ä½¿ç”¨æ ‡å‡† SDXL Base 1.0
model_id = "stabilityai/stable-diffusion-xl-base-1.0"

print(f"ğŸš€ Loading SDXL model from {model_id}...")
try:
    base_pipe = StableDiffusionXLPipeline.from_pretrained(
        model_id,
        torch_dtype=torch.float16 if device == "cuda" else torch.float32,
        variant="fp16" if device == "cuda" else None,
        use_safetensors=True
    ).to(device)
except Exception as e:
    print(f"Error loading model: {e}")
    print("Tip: If running offline, make sure the model is cached or set 'local_files_only=True'")
    exit(1)

# ==============================================================================
# 2. åˆå§‹åŒ– CARC å¼•æ“
# ==============================================================================
print("ğŸ”§ Initializing CARC Engine...")
# Alpha è°ƒåº¦é…ç½®ï¼šæ„å›¾æœŸå¼±æ³¨å…¥ï¼Œçº¹ç†æœŸå¼ºæ³¨å…¥ï¼Œæ”¶å°¾æœŸä¸­ç­‰
alpha_config = {
    "construct_phase": (0.0, 0.35, 0.2),  # 0-35%: 0.2
    "texture_phase":   (0.35, 0.75, 0.8), # 35-75%: 0.8
    "refine_phase":    (0.75, 1.0, 0.5),  # 75-100%: 0.5
}

carc_pipe = CARCPipeline(
    base_pipe=base_pipe,
    alpha_cfg=alpha_config
)

# ==============================================================================
# 3. å®šä¹‰ç”Ÿæˆä»»åŠ¡ (The "Impossible" Prompt)
# ==============================================================================
# ç›®æ ‡ï¼šå·¦è¾¹çº¢çŒ«ï¼Œå³è¾¹è“ç‹—ï¼Œäº’ä¸ä¸²è‰²ï¼Œå…‰å½±ç»Ÿä¸€
subjects = [
    {
        "name": "cat",
        "prompt": "a red cat, high detail, fluffy",
        "position": "left",
        "neg_target": "a blue dog"  # <--- è¯­ä¹‰äº’æ–¥ï¼šç”ŸæˆçŒ«æ—¶ï¼Œæ’æ–¥ç‹—çš„ç‰¹å¾
    },
    {
        "name": "dog",
        "prompt": "a blue dog, high detail",
        "position": "right",
        "neg_target": "a red cat"   # <--- è¯­ä¹‰äº’æ–¥
    }
]

global_prompt = "A sunny park background with green grass and trees, cinematic lighting, 8k, photorealistic"

# ==============================================================================
# 4. æ‰§è¡Œç”Ÿæˆ
# ==============================================================================
print("ğŸ¨ Generating image (this may take a minute)...")

seed = 42  # å›ºå®šç§å­ä»¥ä¾¿å¤ç°
output = carc_pipe(
    global_prompt=global_prompt,
    subjects=subjects,
    width=1024,
    height=1024,
    num_inference_steps=40,    # SDXL æ ‡å‡†æ­¥æ•°
    cfg_pos=7.5,               # æ­£å‘å¼•å¯¼å¼ºåº¦
    cfg_neg=4.0,               # äº’æ–¥å¼•å¯¼å¼ºåº¦ (å»ºè®® 2.0 - 5.0)
    mask_update_interval=5,    # æ¯5æ­¥æ ¹æ® Attention æ›´æ–°ä¸€æ¬¡ Mask
    bg_update_interval=5,      # æ¯5æ­¥æ›´æ–°ä¸€æ¬¡èƒŒæ™¯ KV (ä¼˜åŒ–é€Ÿåº¦)
    beta=0.7,                  # Mask åŠ¨é‡ (0.7 ä»£è¡¨ä¿ç•™ 70% çš„å†å²å½¢çŠ¶)
    safety_expand=0.15,        # å…è®¸ Mask è¶Šç•Œ 15%
    seed=seed
)

# ==============================================================================
# 5. ä¿å­˜ç»“æœ
# ==============================================================================
os.makedirs("outputs", exist_ok=True)
save_path = f"outputs/carc_demo_seed{seed}.png"
save_output(output, save_path)

print(f"âœ… Done! Image saved to: {save_path}")
print("Check if the cat is RED and the dog is BLUE without color bleeding.")
