import torch
import os
from diffusers import StableDiffusionXLPipeline
from pipeline_carc import CARCPipeline, save_output

# ==============================================================================
# 1. åŠ è½½æ¨¡å‹ (FP32 Mode)
# ==============================================================================
device = "cuda" if torch.cuda.is_available() else "cpu"
model_id = "stabilityai/stable-diffusion-xl-base-1.0"

print(f"ğŸš€ Loading SDXL model in FP32 Mode...")
try:
    base_pipe = StableDiffusionXLPipeline.from_pretrained(
        model_id,
        use_safetensors=True,
    ).to(device)
    
    # Force FP32 Components
    base_pipe.vae.to(dtype=torch.float32)
    base_pipe.text_encoder.to(dtype=torch.float32)
    base_pipe.text_encoder_2.to(dtype=torch.float32)
    base_pipe.unet.to(dtype=torch.float32)
    
except Exception as e:
    print(f"Error loading model: {e}")
    exit(1)

# ==============================================================================
# 2. åˆå§‹åŒ– CARC å¼•æ“
# ==============================================================================
print("ğŸ”§ Initializing CARC Engine (Math-Corrected Masking)...")

# æ³¨å…¥é…ç½®ï¼šä¿æŒå¼ºåŠ›ï¼Œç¡®ä¿å…‰å½±ç»Ÿä¸€
alpha_config = {
    "construct_phase": (0.0, 0.4, 0.5), 
    "texture_phase":   (0.4, 0.8, 1.0), 
    "refine_phase":    (0.8, 1.0, 0.6), 
}

# æ³¨å…¥å±‚
inject_patterns = ["down_blocks.2", "mid_block", "up_blocks.0", "up_blocks.1"]

carc_pipe = CARCPipeline(
    base_pipe=base_pipe,
    alpha_cfg=alpha_config,
    inject_layer_patterns=inject_patterns
)

# ==============================================================================
# 3. æç¤ºè¯ç­–ç•¥ (Context Sharing)
# ==============================================================================
bg_suffix = "in a beautiful sunny park with green grass, blurred background, cinematic lighting, 8k"

subjects = [
    {
        "name": "cat",
        # æç¤ºè¯å¼ºè°ƒ "å…¨èº«"ï¼Œé˜²æ­¢åªç”»å¤´
        "prompt": f"a red cat sitting on the grass, full body, fluffy, {bg_suffix}", 
        "position": "left",
        "neg_target": "blue dog"
    },
    {
        "name": "dog",
        "prompt": f"a blue dog sitting on the grass, full body, {bg_suffix}",
        "position": "right",
        "neg_target": "red cat"
    }
]

global_prompt = f"A wide photo of a red cat and a blue dog, {bg_suffix}"

# ==============================================================================
# 4. æ‰§è¡Œç”Ÿæˆ (Final Verified Params)
# ==============================================================================
print("ğŸ¨ Generating image (Dynamic Mask Enabled)...")

# ç§å­ 2024 åœ¨ä¹‹å‰çš„æµ‹è¯•ä¸­æ„å›¾ä¸é”™
seed = 2024 

output = carc_pipe(
    global_prompt=global_prompt,
    subjects=subjects,
    width=1024,
    height=1024,
    num_inference_steps=40,
    
    # å¼•å¯¼å¼ºåº¦
    cfg_pos=7.5,
    cfg_neg=3.0,   # é€‚åº¦äº’æ–¥ï¼Œä¿è¯é¢œè‰²ä¸ä¸²ï¼Œåˆä¸ç ´åç»“æ„
    
    # Mask ç­–ç•¥ (æ ¸å¿ƒæ”¹åŠ¨)
    mask_update_interval=5,    # å¼€å¯åŠ¨æ€æ›´æ–°ï¼ç°åœ¨ Mask é€»è¾‘ä¿®å¥½äº†ï¼Œå¯ä»¥è®©å®ƒè‡ªé€‚åº”äº†
    bg_update_interval=2,      
    
    # Mask å‚æ•° (é…åˆæ–°çš„ mask_manager)
    beta=0.7,                  # åŠ¨é‡ 0.7ï¼Œä¿æŒç¨³å®š
    safety_expand=0.2,         # å…è®¸ 20% è¶Šç•Œ
    
    seed=seed
)

# ==============================================================================
# 5. ä¿å­˜
# ==============================================================================
os.makedirs("outputs", exist_ok=True)
save_path = f"outputs/carc_final_seed{seed}.png"
save_output(output, save_path)

print(f"âœ… Done! Image saved to: {save_path}")
print("Expectation: Separated Red Cat / Blue Dog, unified background, no hard seam.")
