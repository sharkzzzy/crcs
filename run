import torch
import os
from diffusers import StableDiffusionXLPipeline
from pipeline_carc import CARCPipeline, save_output

# ==============================================================================
# 1. é…ç½®ä¸æ¨¡å‹åŠ è½½ (FP32 å…¨ç²¾åº¦æ¨¡å¼ - æœ€ç¨³)
# ==============================================================================
device = "cuda" if torch.cuda.is_available() else "cpu"
model_id = "stabilityai/stable-diffusion-xl-base-1.0"

print(f"ğŸš€ Loading SDXL model in FP32 Mode...")
try:
    base_pipe = StableDiffusionXLPipeline.from_pretrained(
        model_id,
        use_safetensors=True,
        # local_files_only=True 
    ).to(device)
    
    # å¼ºåˆ¶å…¨ FP32 é˜²æ­¢é»‘å›¾å’Œæº¢å‡º
    base_pipe.vae.to(dtype=torch.float32)
    base_pipe.text_encoder.to(dtype=torch.float32)
    base_pipe.text_encoder_2.to(dtype=torch.float32)
    base_pipe.unet.to(dtype=torch.float32)
    
except Exception as e:
    print(f"Error loading model: {e}")
    exit(1)

# ==============================================================================
# 2. åˆå§‹åŒ– CARC å¼•æ“ (å‚æ•°è°ƒä¼˜ç‰ˆ)
# ==============================================================================
print("ğŸ”§ Initializing CARC Engine with Aggressive Injection...")

# ã€è°ƒä¼˜ 1ã€‘å¢å¼ºæ³¨å…¥å¼ºåº¦ï¼Œè§£å†³æ‹¼æ¥ç”Ÿç¡¬é—®é¢˜
alpha_config = {
    "construct_phase": (0.0, 0.4, 0.4),  # æ—©æœŸå°±å¼€å§‹æ³¨å…¥ (0.4)
    "texture_phase":   (0.4, 0.8, 1.0),  # ä¸­æœŸæ‹‰æ»¡ (1.0)ï¼Œå¼ºè¡Œç»Ÿä¸€å…‰å½±
    "refine_phase":    (0.8, 1.0, 0.6),  # å°¾æœŸä¿ç•™ (0.6)
}

# ã€è°ƒä¼˜ 2ã€‘æ‰©å¤§æ³¨å…¥èŒƒå›´ï¼ŒåŠ å› up_blocks.1 (64x64)
# è™½ç„¶å¢åŠ äº†æ˜¾å­˜å‹åŠ›ï¼Œä½† FP32 ä¸‹ 24G æ˜¾å­˜åº”è¯¥èƒ½æ‰›ä½ã€‚è¿™å±‚å¯¹èåˆæœ€é‡è¦ã€‚
inject_patterns = ["down_blocks.2", "mid_block", "up_blocks.0", "up_blocks.1"]

carc_pipe = CARCPipeline(
    base_pipe=base_pipe,
    alpha_cfg=alpha_config,
    inject_layer_patterns=inject_patterns
)

# ==============================================================================
# 3. å®šä¹‰ç”Ÿæˆä»»åŠ¡
# ==============================================================================
# æç¤ºè¯å¾®è°ƒï¼šå¼ºè°ƒå…¨èº«ï¼Œé˜²æ­¢åªç”»åŠä¸ª
subjects = [
    {
        "name": "cat",
        "prompt": "a full body red cat sitting on grass, fluffy, photorealistic",
        "position": "left",
        "neg_target": "a blue dog"
    },
    {
        "name": "dog",
        "prompt": "a full body blue dog sitting on grass, photorealistic",
        "position": "right",
        "neg_target": "a red cat"
    }
]

global_prompt = "A sunny park background with green grass and trees, cinematic lighting, 8k, photorealistic, wide angle"

# ==============================================================================
# 4. æ‰§è¡Œç”Ÿæˆ (å‚æ•°è°ƒä¼˜ç‰ˆ)
# ==============================================================================
print("ğŸ¨ Generating image (Tuned for Coherence)...")

seed = 12345 # æ¢ä¸ªç§å­è¯•è¯•è¿æ°”
output = carc_pipe(
    global_prompt=global_prompt,
    subjects=subjects,
    width=1024,
    height=1024,
    num_inference_steps=40,
    
    cfg_pos=7.5,
    cfg_neg=4.0,
    
    # ã€è°ƒä¼˜ 3ã€‘åŠ å¿« Mask æ›´æ–°ï¼Œå…è®¸æ›´å¤§è¶Šç•Œ
    mask_update_interval=2,    # æ¯2æ­¥å°±æ›´æ–°ä¸€æ¬¡ Mask (åŸä¸º5)
    bg_update_interval=2,      # èƒŒæ™¯ä¹Ÿå‹¤å¿«ç‚¹æ›´æ–°
    
    beta=0.6,                  # é™ä½åŠ¨é‡ (åŸ0.7)ï¼Œè®© Mask å˜åŒ–æ›´çµæ•
    safety_expand=0.35,        # å…è®¸è¶Šç•Œ 35% (åŸ0.15)ï¼Œè®©çŒ«ç‹—èƒ½é•¿è¿‡ä¸­çº¿
    
    seed=seed
)

# ==============================================================================
# 5. ä¿å­˜ç»“æœ
# ==============================================================================
os.makedirs("outputs", exist_ok=True)
save_path = f"outputs/carc_tuned_seed{seed}.png"
save_output(output, save_path)

print(f"âœ… Done! Image saved to: {save_path}")
