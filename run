import os
import torch
from diffusers import StableDiffusionXLPipeline
from pipeline_carc import CARCPipeline, save_output

def main():
    device = "cuda" if torch.cuda.is_available() else "cpu"
    model_id = "stabilityai/stable-diffusion-xl-base-1.0"
    print(f"Loading SDXL Base in FP32 on {device}...")

    base_pipe = StableDiffusionXLPipeline.from_pretrained(
        model_id,
        use_safetensors=True,
    ).to(device)

    # 1. 强制 FP32
    base_pipe.vae.to(dtype=torch.float32)
    base_pipe.text_encoder.to(dtype=torch.float32)
    base_pipe.text_encoder_2.to(dtype=torch.float32)
    base_pipe.unet.to(dtype=torch.float32)

    base_pipe.enable_vae_tiling()
    base_pipe.enable_vae_slicing()

    # 2. 注入配置：低/中层注入
    inject_patterns = ["down_blocks.2", "mid_block", "up_blocks.0"]
    alpha_config = {
        "construct_phase": (0.0, 0.35, 0.15),
        "texture_phase":   (0.35, 0.75, 0.55),
        "refine_phase":    (0.75, 1.0, 0.45),
    }

    carc_pipe = CARCPipeline(
        base_pipe=base_pipe,
        alpha_cfg=alpha_config,
        inject_layer_patterns=inject_patterns
    )

    # 3. 提示词策略 (Clean Global Prompt)
    # 【关键】全局只画背景，绝对不提猫和狗！
    global_prompt = "A wide cinematic photo of a sunny park with green grass and trees, blurred background, high clarity, 8k"

    subjects = [
        {
            "name": "cat",
            "prompt": "a red cat, full body, fluffy, sharp details, left side, full face, clearly separated",
            "position": "left",
            "neg_target": "blue dog, blue fur",
        },
        {
            "name": "dog",
            "prompt": "a blue dog, full body, sharp details, right side, full face, clearly separated",
            "position": "right",
            "neg_target": "red cat, red fur",
        }
    ]

    print("Generating image (Clean Background + Strict Isolation)...")
    seed = 2024

    result = carc_pipe(
        global_prompt=global_prompt,
        subjects=subjects,
        width=1024,
        height=1024,
        num_inference_steps=40,

        cfg_pos=7.0,
        cfg_neg=3.0,

        mask_update_interval=6,
        bg_update_interval=4,

        beta=0.6,
        safety_expand=0.05,   # 严防越界
        gap_ratio=0.08,       # 初始留出 8% 的中缝
        kappa=1.5,            # 强力差分

        seed=seed,
    )

    os.makedirs("outputs", exist_ok=True)
    save_path = f"outputs/carc_final_clean_seed{seed}.png"
    save_output(result, save_path)
    print(f"Done. Saved to: {save_path}")

if __name__ == "__main__":
    main()
