import os
import torch
from diffusers import StableDiffusionXLPipeline
from pipeline_carc import CARCPipeline, save_output

def main():
    device = "cuda" if torch.cuda.is_available() else "cpu"
    model_id = "stabilityai/stable-diffusion-xl-base-1.0"
    print(f"Loading SDXL Base in FP32 on {device}...")

    base_pipe = StableDiffusionXLPipeline.from_pretrained(
        model_id,
        use_safetensors=True,
    ).to(device)

    # 全 FP32 保证稳定
    base_pipe.vae.to(dtype=torch.float32)
    base_pipe.text_encoder.to(dtype=torch.float32)
    base_pipe.text_encoder_2.to(dtype=torch.float32)
    base_pipe.unet.to(dtype=torch.float32)

    base_pipe.enable_vae_tiling()
    base_pipe.enable_vae_slicing()

    # CARC 初始化：【关键】移除高分层注入，防止语义污染
    inject_patterns = ["down_blocks.2", "mid_block", "up_blocks.0"]
    alpha_config = {
        "construct_phase": (0.0, 0.35, 0.15),
        "texture_phase":   (0.35, 0.75, 0.55),
        "refine_phase":    (0.75, 1.0, 0.45),
    }

    carc_pipe = CARCPipeline(
        base_pipe=base_pipe,
        alpha_cfg=alpha_config,
        inject_layer_patterns=inject_patterns
    )

    # 提示词：背景全局，主体局部
    global_bg = "in a sunny park with green grass and trees, cinematic lighting, high clarity"
    global_prompt = f"A wide photo of a red cat and a blue dog {global_bg}"

    subjects = [
        {
            "name": "cat",
            "prompt": "a red cat, full body, fluffy, sharp details, left side, full face, clearly separated, not merged",
            "position": "left",
            "neg_target": "blue dog, blue fur",
        },
        {
            "name": "dog",
            "prompt": "a blue dog, full body, sharp details, right side, full face, clearly separated, not merged",
            "position": "right",
            "neg_target": "red cat, red fur",
        }
    ]

    print("Generating image with FP32 & CARC (Exclusive Masks & Differential Blending)...")
    seed = 2024

    result = carc_pipe(
        global_prompt=global_prompt,
        subjects=subjects,
        width=1024,
        height=1024,
        num_inference_steps=40,

        cfg_pos=7.0,
        cfg_neg=3.0,          

        mask_update_interval=6,
        bg_update_interval=4,

        beta=0.6,
        safety_expand=0.05,   # 【关键】极小的越界许可，配合 Gap Logic 彻底分开
        kappa=1.5,            # 【关键】强力的差分融合，提取主体特征

        seed=seed,
    )

    os.makedirs("outputs", exist_ok=True)
    save_path = f"outputs/carc_fp32_separate_seed{seed}.png"
    save_output(result, save_path)
    print(f"Done. Saved to: {save_path}")

if __name__ == "__main__":
    main()
