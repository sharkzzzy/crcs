import torch
import os
from diffusers import StableDiffusionXLPipeline
from pipeline_carc import CARCPipeline, save_output

# ==============================================================================
# 1. åŠ è½½æ¨¡å‹ (FP32 Mode)
# ==============================================================================
device = "cuda" if torch.cuda.is_available() else "cpu"
model_id = "stabilityai/stable-diffusion-xl-base-1.0"

print(f"ğŸš€ Loading SDXL model in FP32 Mode...")
try:
    base_pipe = StableDiffusionXLPipeline.from_pretrained(
        model_id,
        use_safetensors=True,
    ).to(device)
    
    # Force FP32 Components
    base_pipe.vae.to(dtype=torch.float32)
    base_pipe.text_encoder.to(dtype=torch.float32)
    base_pipe.text_encoder_2.to(dtype=torch.float32)
    base_pipe.unet.to(dtype=torch.float32)
    
except Exception as e:
    print(f"Error loading model: {e}")
    exit(1)

# ==============================================================================
# 2. åˆå§‹åŒ– CARC å¼•æ“
# ==============================================================================
print("ğŸ”§ Initializing CARC Engine (Math-Corrected Masking)...")
alpha_config = {
    "construct_phase": (0.0, 0.35, 0.15),
    "texture_phase":   (0.35, 0.75, 0.6),
    "refine_phase":    (0.75, 1.0, 0.45),
}

# ã€ä¼˜åŒ–ã€‘åªåœ¨é«˜åˆ†å±‚å¾®è°ƒ (up.2)ï¼Œé¿å¼€ä¸­é—´å±‚ (up.1) çš„è¿‡åº¦å¹²æ‰°
inject_patterns = ["down_blocks.2", "mid_block", "up_blocks.0", "up_blocks.2"]

carc_pipe = CARCPipeline(
    base_pipe=base_pipe,
    alpha_cfg=alpha_config,
    inject_layer_patterns=inject_patterns
)

# ==============================================================================
# 3. æç¤ºè¯ç­–ç•¥ (åˆ†ç¦»èƒŒæ™¯ä¸ä¸»ä½“)
# ==============================================================================
# å…¨å±€ï¼šè´Ÿè´£ç”»ç¯å¢ƒ
global_prompt = "A wide cinematic photo of a red cat and a blue dog in a sunny park with green grass, blurred background, 8k, photorealistic, masterpiece"

# ä¸»ä½“ï¼šåªè´Ÿè´£ç”»è‡ªå·±ï¼Œä¸é‡å¤èƒŒæ™¯è¯ -> æå‡ç»†èŠ‚é”åº¦
subjects = [
    {
        "name": "cat",
        "prompt": "a red cat, full body, fluffy fur, sharp detailed face, bright eyes, sitting pose, left side", 
        "position": "left",
        "neg_target": "blue dog"
    },
    {
        "name": "dog",
        "prompt": "a blue dog, full body, sharp detailed face, bright eyes, sitting pose, right side",
        "position": "right",
        "neg_target": "red cat"
    }
]

# ==============================================================================
# 4. æ‰§è¡Œç”Ÿæˆ
# ==============================================================================
print("ğŸ¨ Generating image...")

seed = 2024
output = carc_pipe(
    global_prompt=global_prompt,
    subjects=subjects,
    width=1024,
    height=1024,
    num_inference_steps=40,
    
    cfg_pos=7.5,
    cfg_neg=3.0,
    kappa=1.3,     # å·®åˆ†å¢å¼ºï¼Œè¿›ä¸€æ­¥é”åŒ–
    
    mask_update_interval=5,
    bg_update_interval=2,
    
    beta=0.7,
    safety_expand=0.2,
    
    seed=seed
)

# ==============================================================================
# 5. ä¿å­˜
# ==============================================================================
os.makedirs("outputs", exist_ok=True)
save_path = f"outputs/carc_fp32_opt_seed{seed}.png"
save_output(output, save_path)

print(f"âœ… Done! Image saved to: {save_path}")
